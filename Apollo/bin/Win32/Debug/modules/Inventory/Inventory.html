<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<script type="text/javascript" src="../WebView/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="../WebView/jquery-ui-1.8.13.custom.min.js"></script> 
<script type="text/javascript" src="../WebView/apollo.js"></script>

<style type="text/css">
* { margin:0; padding:0; }

*
{
  font-family:Verdana, Arial, Sans-Serif;
  font-size:11px;
}

#Wrapper {
  position:absolute;
  left:4px;
  top:4px;
  right:4px;
  bottom:4px;
  background-color:#ffffff;
  padding:4px;
}

.Items
{
  position:absolute;
  left:0px;
  top:0px;
  right:0px;
  bottom:0px;
}

.Panel .Name 
{
  display:none;
}

.Item {
  float: left;
  border: solid 1px #D0D0D0;
  background-color:#ffffff;
  margin: 1px;
  padding: 2px;
  overflow: hidden;
  height: 100px;
  width: 100px;
}

.Item img.Icon {
  margin-right: 4px;
}

.Panel .Item .Name 
{
  display:inline;
}

.Item .Nickname 
{
  font-weight:bold;
}

.Item .Stacksize {
  float: right;
  margin-left: 2px;
}
</style>

<script type="text/javascript">

var api = new ApolloApi('Chat');

function ReceiveMessageFromModule(sMsg) {
  //api.Log.Debug('ReceiveMessageFromModule ' + sMsg);

  var msg = new ApMessage().fromString(sMsg);
  var resp = null;

  try {

    var sMethod = msg.getString('Method');
    switch (sMethod) {
      case 'Start': return Start(); break;
      case 'PurgePanels': return PurgePanels(); break;
      case 'AddPanel': return AddPanel(msg.getString('Panel'), msg.getString('Name'), msg.getInt('Order'), msg.getInt('Slots')); break;
      case 'RemovePanel': return RemovePanel(msg.getString('Panel')); break;
      case 'AddItem': return AddItem(msg.getString('Panel'), msg.getString('Id'), msg); break;
      case 'RemoveItem': return RemoveItem(msg.getString('Panel'), msg.getString('Id')); break;
      default: throw 'Unknown method: ' + sMethod;
    }

  } catch (ex) {
    resp = new ApMessage().setInt('Status', 0).setString('Message', String(ex));
  }

  if (resp != null) {
    var sResponse = resp.toString();
    return sResponse;
  }
}

function Start() {
  api = new ApolloApi('Inventory');
  api.ModuleCall('OnPlayModel').send();
}

function PurgePanels() {
  $('#Wrapper').empty();
}

function AddPanel(sPanelId, sName, nOrder, nSlots) {
  $('#Wrapper').append(''
        + '<div id="Panel_' + sPanelId + '" class="Panel">'
        + '  <div class="Name">' + sName + '</div>'
        + '  <div class="Items"></div>'
        + '</div>'
      );
}

function RemovePanel(sPanelId) {
  $('#Panel_' + sPanelId).remove();
}

function AddItem(sPanelId, sItemId, props) {
  var sName = props.getString('Name');
  var sNickname = props.getString('Nickname');
  var sIcon = props.getString('Icon32Url');
  var nSlot = props.getInt('Slot');
  var nStacksize = props.getInt('Stacksize');

  $('#Panel_' + sPanelId).append(''
        + '<div id="Item_' + sItemId + '" class="Item">'
        + '  <img src="' + sIcon + '" class="Icon" />'
        + '  <div class="Stacksize">' + nStacksize + '</div>'
        + (sNickname != '' ? '  <div class="Nickname">' + sNickname + '</div>' : '')
        + '  <div class="Name">' + sName + '</div>'
        + '  <div class="ItemId">' + sItemId + '</div>'
        + '  <input type="button" class="Drag" value="Drag"/>'
        + '</div>'
      );

    $('#Item_' + sItemId + ' .Drag').mousedown(
      function (ev) {
        OnDragItem(sItemId, ev.pageX, ev.pageY);
      });

  //  $('#Item_' + sItemId).mousedown(
  //    function (ev) {
  //      //api.Log.Debug('pageX=' + ev.pageX + ' pageY=' + ev.pageY);
  //      OnDragItem(sItemId, ev.pageX, ev.pageY);
  //    });

  var nLastX = 0;
  var nLastY = 0;

  $('#Item_' + sItemId).draggable({
    distance: 8,
    stack: 'div',
    xdelay: 200,
    xgrid: [108, 108],
    xcursor: 'move',
    xcursorAt: { top: 50, left: 50 },
    containment: '#Panel_' + sPanelId + ' .Items',
    start: function (ev) {
      nLastX = ev.pageX;
      nLastY = ev.pageY;
      //api.Message('WebView_MouseCapture').setString('hView', api.GetViewHandle()).send();
    },
    drag: function (ev) {
      var nDX = ev.pageX - nLastX;
      var nDY = ev.pageY - nLastY;
      //api.Log.Debug('dx=' + nDX + ' dY=' + nDY);
      nLastX = ev.pageX;
      nLastY = ev.pageY;
    },
    stop: function (ev) {

    }
  });
}

function RemoveItem(sPanelId, sItemId) {
  $('#Item_' + sItemId).remove();
}

// -----------------------------------------------

function OnDragItem(sItemId, nX, nY) {
  var eItem = $('#Item_' + sItemId);
  var off = eItem.offset();

  var nLeft = off.left + 3;
  var nTop = off.top + 3;
  var nWidth = eItem.width();
  var nHeight = eItem.height();
  var nOffsetX = nX - nLeft;
  var nOffsetY = nY - nTop;

  api.ModuleCall('OnDragItem')
     .setString('sItemId', sItemId)
     .setInt('nLeft', nLeft)
     .setInt('nTop', nTop)
     .setInt('nWidth', nWidth)
     .setInt('nHeight', nHeight)
     .setInt('nOffsetX', nOffsetX)
     .setInt('nOffsetY', nOffsetY)
     .send();
}

// -----------------------------------------------

</script>

</head>

<body>
<div id="Wrapper">
Inventory
</div>
</body>

</html>
