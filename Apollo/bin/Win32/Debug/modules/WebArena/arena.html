<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<script type="text/javascript" src="jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="utils.js"></script>
<script type="text/javascript" src="apollo.js"></script>
<script type="text/javascript" src="arena.js"></script>
<link rel='stylesheet' href='arena.css' type='text/css' media='all' />

<script type="text/javascript">
function Eval(sText) { eval(sText); }

function ReceiveMessage(sMsg)
{
  return api.receiveMessage(sMsg);
}

function DispatchMessage(msg)
{
  var sMethod = msg.getString('Method');
  switch (sMethod) {
    case 'AddAvatar': return arena.AddAvatar(msg.getString('hParticipant'), msg.getString('sNickname'), msg.getString('sImageUrl'), msg.getInt('nX')); break;
    case 'RemoveAvatar': return arena.RemoveAvatar(msg.getString('hParticipant')); break;
    case 'ShowAvatar': return arena.ShowAvatar(msg.getString('hParticipant')); break;
    case 'HideAvatar': return arena.HideAvatar(msg.getString('hParticipant')); break;

    case 'SetAvatarPosition': return arena.SetAvatarPosition(msg.getString('hParticipant'), msg.getInt('nX')); break;
    case 'SetAvatarNickname': return arena.SetAvatarNickname(msg.getString('hParticipant'), msg.getString('sNickname')); break;
    case 'SetAvatarImage': return arena.SetAvatarImage(msg.getString('hParticipant'), msg.getString('sUrl')); break;
    case 'SetAvatarChat': return arena.SetAvatarChat(msg.getString('hParticipant'), msg.getString('hChat'), msg.getString('sText')); break;

    case 'SetDocumentUrl': return arena.SetDocumentUrl(msg.getString('sUrl')); break;
    case 'SetLocationUrl': return arena.SetLocationUrl(msg.getString('sUrl')); break;
    case 'SetLocationState': return arena.SetLocationState(msg.getString('sState')); break;

    default: throw 'Unknown method: ' + sMethod;
  }
}

function RunUnittest()
{
    var t = new Unittest();
    t.Add('Unittest.SuccessTest', Unittest.SuccessTest);
    //t.Add('Unittest.FailedTest', Unittest.FailedTest);
    //t.Add('Unittest.ExceptionTest', Unittest.ExceptionTest);
    t.Add('Observable Basic', Observable_Tester.Basic);
    t.Add('Observable Remove', Observable_Tester.Remove);
    t.Add('Observable Serialize', Observable_Tester.Serialize);
    t.Add('String.toDomCompatible', String_Tester.toDomCompatible);

    t.Run();
}

  var api = new ApolloApi();
  api.moduleName = 'WebArena';
  api.onDispatchMessage = DispatchMessage;
  api.init();

  var logger = Log.GetInstance('iOut', 'iLogCheck');
  Log.instance.SetLevel(Log.Level.VERBOSE);
  Log.instance.Clear();

  ApMessage.prototype.onLog = Log.IO;

  $(document).ready(function () {
    arena = new Arena('iContent');
    arena.Startup();
  });
</script>

<style type="text/css">
#iContent { -webkit-box-shadow:inset 0 0 1px 1px #505050; }
#iControl { background-color:rgba(255,255,204,0.7); }
#iControl * { font-family:Verdana; font-size:11px; }
#iOut { background-color:rgba(240,240,240,0.9); }
#iOut p { font-family:Lucida Console; font-size:10px; }
</style>

</head>
<body style="overflow:hidden;">
<div id="iWrapper" style="width:100%; height:100%">

  <div id="iContent" style="position:absolute; left:0; top:0; width:40%; height:100%; overflow:auto;">
    <div style="position:absolute; left:0px; bottom:0px; height:20px; width:60px; -webkit-box-shadow:inset 0 0 1px 1px#000000;
;"></div>

    <div class="cParticipant" id="iParticipant" style="left:110px;">
      <div class="cCenter">
        <div class="cChatWrapper">
          <div class="cChatContainer">
            <div class="cChat" id="iChat1">hasjd haksjd haksd sdjfasdjf </div>
            <div class="cChat" id="iChat2">ajhd</div>
            <div class="cChat" id="iChat3"> hasjd haksjd haksd fajhdgf ajhd 
            gajshdgf ajshdg fajshd hasjd haksjd haksd fajhdgf ajhd gajshdgf 
            ajshdg fajshdaskjdhfakjdhalskjdfsdfqeowrfhafjghdfjh hasjd haksjd
             haksd fajhdgf ajhd gajshdgf</div>
          </div>
        </div>
        <div class="cImageWrapper">
          <div class="cImage"></div>
          <div class="cNickname">Long Nickname</div>
          <div class="cImageSensor">
            <div class="cMenu" style="display:none"><img class="cBubble" src="Bubble.png" /></div>
            <div class="cChatIn" style="display:none; white-space:nowrap">
              <table border="0" cellpadding="0" cellspacing="0"><tr>
                <td><input type="text" class="cText" size="30" /></td>
                <td><img src="CloseButton.png" class="cCloseButton" /></td>
                </tr></table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
  <div id="iControl" style="position:absolute; left:40%; top:0; width:10%; height:100%; overflow:auto;">
    <input type="button" value="WebView_Reload" onclick="api.newMessage('WebView_Reload').send();" />
    <input type="button" value="reload()" onclick="document.location.reload();" />
    <input type="button" value="Quit" onclick="api.newMessage('MainLoop_EndLoop').send();"/>
    <input type="button" value="Unittest" onclick="RunUnittest();"/>
    <input type="checkbox" id="iLogCheck" checked="checked"/><label for="iLogCheck">Logging</label>
    <input type="button" value="Clear" onclick="Log.instance.Clear();" />
    <input type="button" value="Translate" onclick="Log.Info(api.translate('ParamTest', 'Click me!'));" />
  </div>
  <div id="iOut" style="position:absolute; left:50%; top:0; width:50%; height:100%; overflow:auto; white-space: nowrap;"></div>
</div>
</body>

<script type="text/javascript">

$('.cImageSensor').hover(
  function ()
  {
    $('.cMenu').stop(true).fadeTo('fast',1);
  }, 
  function ()
  {
    $('.cMenu').fadeTo('fast',0);
  }
);

$('.cBubble').click(
  function ()
  {
    $('.cMenu').fadeTo('fast', 0);
    $('.cChatIn').fadeIn('fast', 
      function()
      {
        $('.cChatIn .cText').focus();
      }
    );
  }
);

$('.cCloseButton').hover(
  function ()
  {
    $(this).attr('src', 'CloseButtonHover.png');
  }, 
  function ()
  {
    $(this).attr('src', 'CloseButton.png');
  }
).click(
  function ()
  {
    $('.cChatIn').fadeOut('fast');
  }
);

$('.cChatIn .cText').bind("keydown", 
  function(event)
  {
    var keycode = (event.keyCode ? event.keyCode : (event.which ? event.which : event.charCode));
    if (keycode == 13) {
      //api.newMessage('SendPublicChat').setString('ApType', 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX').send();
      return false;
    } else {
      return true;
    }
  }
);

</script>

</html>
