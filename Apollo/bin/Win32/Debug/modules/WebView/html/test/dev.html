<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<script type="text/javascript">
// ------------------------------------------

function SrpcMessage()
{
	this.aParams_ = new Array();
}

// ---------------------
// Setter

SrpcMessage.prototype.fromString = function(sMsg)
{
	var aLines = sMsg.split("\n");
	if (aLines.length > 0) {
    for (var i = 0; i < aLines.length; i++) {
      var nIndex = aLines[i].indexOf('=');
			if (nIndex > 0) {
				var sKey = aLines[i].substr(0, nIndex);
				var sValue = aLines[i].substr(nIndex + 1);
				if (sKey != '') {
					this.aParams_[sKey] = sValue;
				}
			}
		}
	}
}

SrpcMessage.prototype.encodeCString = function(sValue)
{
	var sResult = '';
	for (var i = 0; i < sValue.length; i++) {
		switch (sValue.charAt(i)) {
			case '\\': sResult += '\\\\'; break;
			case '\r': sResult += '\\r'; break;
			case '\n': sResult += '\\n'; break;
			default: sResult += sValue.charAt(i);
		}
	}
	return sResult;
}

SrpcMessage.prototype.setString = function(sKey, sValue)
{
	sValue = this.encodeCString(sValue);
	this.aParams_[sKey] = sValue;
	return this;
}

SrpcMessage.prototype.setInt = function(sKey, nValue)
{
	this.aParams_[sKey] = String(nValue);
	return this;
}

SrpcMessage.prototype.setKeyValueList = function(sKey, kvList)
{
  var s = '';
  for (var i in kvList) { 
    s += i + '=' + this.encodeCString(kvList[i]) + '\n';
  }
	this.setString(sKey, s);
	return this;
}

// ---------------------
// Getter

SrpcMessage.prototype.decodeCString = function(sValue)
{
	var sResult = '';
	var bEscape = false;
	for (var i = 0; i < sValue.length; i++) {
		var sChar = sValue.charAt(i);
		if (!bEscape) {
			if (sChar == '\\') {
				bEscape = true;
			} else {
				sResult += sChar;
			}
		} else {
			switch (sChar) {
				case '\\': sChar = '\\'; break;
				case 'r': sChar = '\r'; break;
				case 'n': sChar = '\n'; break;
				default:;
			}
			sResult += sChar;
			bEscape = false;
		}
	}
	return sResult;
}

SrpcMessage.prototype.getString = function(sKey)
{
	var sValue = '';
	if (this.aParams_[sKey]) {
		sValue = this.aParams_[sKey];
		sValue = this.decodeCString(sValue);
	}
	return sValue;
}

SrpcMessage.prototype.getInt = function(sKey)
{
	return parseInt(this.getString(sKey));
}

SrpcMessage.prototype.getKeyValueList = function(sKey)
{
  var kvList = new Object();
  var srpc = new SrpcMessage();
  srpc.fromString(this.getString(sKey));
  for (var i in srpc.aParams_) {
    kvList[i] = srpc.aParams_[i];
  }
	return kvList;
}

// ---------------------
// IO

SrpcMessage.prototype.aRequests_ = new Array();

SrpcMessage.prototype.send = function()
{
  if (apollo) {
    var sMsg = '';
    for (var i in this.aParams_) { sMsg += i + '=' + this.aParams_[i] + '\n'; }
    if (typeof(onLog) == 'function') { onLog(sMsg); }

    var sRespose = apollo.sendMessage(sMsg);
    
    var resp = new SrpcMessage();
    resp.fromString(sRespose);
    
    return resp;
  }
}

// ---------------------
// Unittest

SrpcMessage.prototype.unitTest = function()
{
	var s = '';

	if (!s) {
		var msg = new SrpcMessage();
		msg.fromString('Method=Test\na=b\nc=d\n');
		if (!s) { if (msg.aParams_['Method'] != 'Test') { s = 'Missing Method'; } }
		if (!s) { if (msg.aParams_['a'] != 'b') { s = 'Missing a=b'; } }
		if (!s) { if (msg.aParams_['c'] != 'd') { s = 'Missing c=d'; } }
	}

	if (!s) {
		var msg = new SrpcMessage();
		msg.fromString('Method=Test\na=w=x\\ny=z\\n\nc=d\n');
		if (!s) { if (msg.aParams_['Method'] != 'Test') { s = 'Missing Method'; } }
		if (!s) { if (msg.aParams_['a'] != 'w=x\\ny=z\\n') { s = 'Missing a=w=x\\ny=z\\n'; } }
		if (!s) { if (msg.aParams_['c'] != 'd') { s = 'Missing c=d'; } }
	}

	return s;
}

// ------------------------------------------

//ApMessage.prototype = new SrpcMessage;

//function ApMessage(sType)
//{
//	this.inheritFrom = SrpcMessage;
//  this.inheritFrom();

//	if (sType != null) {
//		this.aParams_['Method'] = 'Host.Call';
//		this.aParams_['ApType'] = sType;
//	}
//}

// ---------------------

//function onLoad(e)
//{
//	new SrpcMessage().setString('Method', 'Display.Loaded').send();
//	window.removeEventListener('load', onLoad, false);
//}

//function onUnload(e)
//{
//	new SrpcMessage().setString('Method', 'Display.BeforeUnload').send();
//	window.removeEventListener('unload', onUnload, false);
//}

//window.addEventListener('load', onLoad, false);
//window.addEventListener('unload', onUnload, false);
</script>

<script type="text/javascript">
  function Elem(sId) { return document.getElementById(sId); }

  function Log(sText) { Elem('iLog').innerHTML = sText; }

  var gStartX = 0; 
  var gStartY = 0; 
  var gMouseActive = false; 
  var gMouseDown = false; 
  var gIsMove = false; 
  var gIsSize = false; 
  var gSizeDirection = 0; 
  var gMinWidth = 150; 
  var gMinHeight = 22; 
  
  function OnMouseDown(ev)
  {
    new SrpcMessage().setString('Method', 'WebView_MouseCapture').setString('hView', apollo.viewHandle).send();
    gMouseDown = true;
    gStartX = ev.x;
    gStartY = ev.y;
    gMouseActive = false;

    if (ev.target.className =='Move') {
      gIsMove = true; 
      gIsSize = false; 
    }
    if (ev.target.className =='SizeBottomRight') {
      gIsMove = false; 
      gIsSize = true; 
      gSizeDirection = 8; 
    }

    Log('MoveMouseDown ' + ev.x + ' ' + ev.y);
  }

  function OnMouseMove(ev)
  {
    if (gMouseDown) {
      var dx = ev.x - gStartX;
      var dy = ev.y - gStartY;
      if (!gMouseActive) {
        if (dx > 4 || dx < -4 || dy > 4 || dy < -4) {
          gMouseActive = true;
        }
      }
      if (gMouseActive) {
        if (gIsMove) {
          new SrpcMessage().setString('Method', 'WebView_MoveBy').setString('hView', apollo.viewHandle).setInt('nX', dx).setInt('nY', dy).send();
          Log('WebView_MoveBy ' + dx + ' ' + dy);
        }
        if (gIsSize) {
          if (dx < 0 || dy < 0) {
            var pos = new SrpcMessage().setString('Method', 'WebView_GetPosition').setString('hView', apollo.viewHandle).send();
            var nW = pos.getInt('nW');
            var nH = pos.getInt('nH');
            var nNewW = nW + dx;
            var nNewH = nH + dy;
            if (nNewW < gMinWidth) { dx = gMinWidth - nW; }
            if (nNewH < gMinHeight) { dy = gMinHeight - nH; }
          }

          new SrpcMessage()
            .setString('Method', 'WebView_SizeBy')
            .setString('hView', apollo.viewHandle)
            .setInt('nW', dx)
            .setInt('nH', dy)
            .setInt('nDirection', gSizeDirection)
            .send();

          Log('WebView_SizeBy ' + dx + ' ' + dy);
          gStartX += dx;
          gStartY += dy;
        }
      }
    }
  }

  function OnMouseUp()
  {
    gMouseDown = false;
    gMouseActive = false;
    gIsMove = false;
    gIsSize = false;
    new SrpcMessage().setString('Method', 'WebView_MouseRelease').setString('hView', apollo.viewHandle);
    Log('MoveMouseUp');
  }

  document.onmousedown = OnMouseDown; 
  document.onmousemove = OnMouseMove; 
  document.onmouseup = OnMouseUp;

  function MoveBy()
  {
    new SrpcMessage()
      .setString('Method', 'WebView_MoveBy')
      .setString('hView', apollo.viewHandle)
      .setInt('nX', Elem('nX').value)
      .setInt('nY', Elem('nY').value)
      .send();
  }

  function SizeBy()
  {
    var msg = new SrpcMessage();
    msg.setString('Method', 'WebView_SizeBy');
    msg.setString('hView', apollo.viewHandle);
    msg.setInt('nH', Elem('nX').value);
    msg.setInt('nW', Elem('nY').value);
    msg.setInt('nDirection', Elem('nDirection').value);
    msg.send();
  }

</script>

<style type="text/css">
* { margin:0; padding:0; -webkit-user-select:none; }
</style>

</head>
<body style="overflow:hidden;">
<div style="width:100%; height:100%; border:1px solid #000000; background-color:rgba(240,240,255,0.7);">
  <div class="Move" style="cursor:default; width:100%; height:20px; border-bottom:1px solid #000000; background-color:#00ff00;">Caption</div>
  <p id="iLog">--</p>
  <img alt="" src="http://webkit.org/images/icon-gold.png" />
  <img alt="" src="test1.png" />
  <p>
    <input type="text" value="10" id="nX" name="nX" />
    <input type="text" value="10" id="nY" name="nY" />
    <input type="text" value="8" id="nDirection" name="nDirection" />
    <input type="button" value="MoveBy" onclick="MoveBy()"/>
    <input type="button" value="SizeBy" onclick="SizeBy()"/>
  </p>
  <div class="SizeBottomRight" style="cursor:se-resize; width:20px; height:20px; background-image:url(sizer-se.png); position:absolute; right:1px; bottom:1px;" />
</div>
</body>
</html>
